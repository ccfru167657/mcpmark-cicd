name: Issue Management Automation
on:
  issues:
    types: [opened, labeled]

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Run issue triaging
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            
            // Initialize labels array with required initial label
            let labelsToAdd = ['needs-triage'];
            
            // Assign category labels based on title keywords
            if (title.includes('bug')) {
              labelsToAdd.push('bug');
            }
            if (title.includes('epic')) {
              labelsToAdd.push('epic');
            }
            if (title.includes('maintenance')) {
              labelsToAdd.push('maintenance');
            }
            
            // Assign priority labels (highest priority first)
            const priorityRules = [
              { keywords: ['critical', 'urgent', 'production', 'outage'], label: 'priority-critical' },
              { keywords: ['important', 'high', 'blocking'], label: 'priority-high' },
              { keywords: ['low', 'nice-to-have', 'minor'], label: 'priority-low' }
            ];
            
            let priorityAssigned = false;
            for (const rule of priorityRules) {
              const hasMatchingKeyword = rule.keywords.some(keyword => title.includes(keyword) || body.includes(keyword));
              if (hasMatchingKeyword) {
                labelsToAdd.push(rule.label);
                priorityAssigned = true;
                break;
              }
            }
            
            // Apply default medium priority if no other priority was assigned
            if (!priorityAssigned) {
              labelsToAdd.push('priority-medium');
            }
            
            // Add all determined labels to the issue
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labelsToAdd
            });

  task-breakdown:
    needs: issue-triage
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'epic')
    steps:
      - name: Create epic subtasks
        uses: actions/github-script@v7
        with:
          script: |
            const parentIssue = context.payload.issue;
            const parentNumber = parentIssue.number;
            const originalTitle = parentIssue.title;
            
            // Define subtask details
            const subtaskDefinitions = [
              { taskName: "Requirements Analysis" },
              { taskName: "Design and Architecture" },
              { taskName: "Implementation" },
              { taskName: "Testing and Documentation" }
            ];
            
            const createdSubtaskNumbers = [];
            
            // Create each subtask
            for (let i = 0; i < subtaskDefinitions.length; i++) {
              const taskIndex = i + 1;
              const subtaskTitle = `[SUBTASK] ${originalTitle} - Task ${taskIndex}: ${subtaskDefinitions[i].taskName}`;
              const subtaskBody = `Related to #${parentNumber}`;
              
              // Create the subtask issue
              const createdSubtask = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: subtaskTitle,
                body: subtaskBody,
                labels: ['enhancement', 'needs-review']
              });
              
              createdSubtaskNumbers.push(createdSubtask.data.number);
            }
            
            // Update parent issue with epic tasks checklist
            const epicChecklist = createdSubtaskNumbers.map(num => `- [ ] #${num}`).join('\n');
            const updatedParentBody = `${parentIssue.body || ''}\n\n## Epic Tasks\n${epicChecklist}`;
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parentNumber,
              body: updatedParentBody
            });

  auto-response:
    needs: [issue-triage, task-breakdown]
    runs-on: ubuntu-latest
    steps:
      - name: Check if author is first-time contributor to this repo
        id: check-first-contributor
        uses: actions/github-script@v7
        with:
          script: |
            const issueAuthor = context.payload.issue.user.login;
            
            // Fetch all issues created by this author in the repository
            const authorIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: issueAuthor,
              state: 'all'
            });
            
            // Return true if this is their only issue (first time contributor)
            return authorIssues.data.length === 1;

      - name: Post automated response and update issue state
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const isFirstContributor = ${{ steps.check-first-contributor.outputs.result }};
            const issueLabels = issue.labels.map(label => label.name);
            
            let responseComment = '';
            
            // Handle first-time contributor welcome
            if (isFirstContributor) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['first-time-contributor']
              });
              
              responseComment += "ðŸ‘‹ Welcome! This is your first issue in this repository. We appreciate your contribution and will review your submission shortly.\n\n";
            }
            
            // Add context-specific guidelines based on issue category
            if (issueLabels.includes('bug')) {
              responseComment += "### Bug Report Guidelines\nPlease ensure you've provided all necessary details including steps to reproduce, expected behavior, and environment information. Our team will investigate this bug report as soon as possible.";
            } else if (issueLabels.includes('epic')) {
              responseComment += "### Feature Request Process\nThis epic has been automatically broken down into subtasks. Our team will review this feature request and begin working through the implementation phases in the coming days.";
            } else if (issueLabels.includes('maintenance')) {
              responseComment += "### Maintenance Guidelines\nThank you for submitting this maintenance task. Our team will review the proposed changes and prioritize this work based on our current roadmap.";
            }
            
            // Post the response comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: responseComment
            });
            
            // Assign milestone for high/critical priority issues
            if (issueLabels.includes('priority-critical') || issueLabels.includes('priority-high')) {
              // Try to get existing v1.0.0 milestone, create if it doesn't exist
              let milestone;
              try {
                milestone = await github.rest.issues.getMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  milestone_number: 1
                });
              } catch (error) {
                // Create milestone if it doesn't exist
                milestone = await github.rest.issues.createMilestone({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: "v1.0.0",
                  state: "open"
                });
              }
              
              // Assign the milestone to the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                milestone: milestone.data.number
              });
            }
            
            // Update status from needs-triage to needs-review
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: "needs-triage"
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['needs-review']
            });